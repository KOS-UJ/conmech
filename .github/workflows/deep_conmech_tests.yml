name: Deep Conmech Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  run_tests:
    runs-on: ubuntu-18.04
    container:
      image: michaljur/deep_conmech:latest
    steps:
      - name: Downloading code
        shell: bash
        run: |
          git init
          url=${{ github.repositoryUrl }}
          git remote add origin ${url/git:/https:}
          git pull origin ${{ github.sha }}
      - name: Fix for problematic requirements
        shell: bash
        run: |
          pip install --upgrade tensorboard
          pip install torch-scatter torch-cluster torch-spline-conv --upgrade --force-reinstall -f https://data.pyg.org/whl/torch-1.11.0+cpu.html
      - name: Install requirements
        shell: bash
        run: |
          pip install -r requirements.txt
      - name: Running tests
        shell: bash
        run: PYTHONPATH=. pytest tests/test_deep_conmech -p no:unraisableexception
